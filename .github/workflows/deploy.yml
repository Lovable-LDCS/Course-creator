name: Deploy to GitHub Pages

# Build Agent Integration:
# This workflow implements automated QA principles to prevent failed builds from deploying:
# - Validates dependencies install correctly
# - Enforces code quality standards via linting
# - Ensures successful build completion
# - Validates build output artifacts exist
# - Only deploys if all validation steps pass

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install dependencies
        # Note: --legacy-peer-deps flag required due to @headlessui/react peer dependency
        # on React ^16||^17||^18, while project uses React 19.2.0. This is a known compatibility
        # issue and the flag is the recommended workaround until library updates.
        run: npm ci --legacy-peer-deps
      
      - name: Lint code
        run: npm run lint
        continue-on-error: false
        
      - name: Build
        run: npm run build
        env:
          VITE_OPENAI_API_KEY: ${{ secrets.VITE_OPENAI_API_KEY }}
          VITE_APP_ENV: production
          NODE_ENV: production
      
      - name: Validate build output
        run: |
          if [ ! -d "dist" ]; then
            echo "Error: dist directory not found"
            exit 1
          fi
          if [ ! -f "dist/index.html" ]; then
            echo "Error: index.html not found in dist"
            exit 1
          fi
          # Verify assets directory exists
          if [ ! -d "dist/assets" ]; then
            echo "Error: assets directory not found in dist"
            exit 1
          fi
          echo "‚úÖ Build validation passed"
          echo "‚úÖ dist directory created"
          echo "‚úÖ index.html exists"
          echo "‚úÖ assets directory exists"
      
      - name: Check for QA compliance (DE-007)
        run: |
          # Verify NotFound component exists in source
          if [ ! -f "src/components/NotFound.tsx" ]; then
            echo "Error: NotFound component not found (QA spec WI-008)"
            exit 1
          fi
          # Verify NotFound component is imported in App.tsx
          if ! grep -q "NotFound" "src/App.tsx"; then
            echo "Error: NotFound component not integrated in routing (QA spec WI-008)"
            exit 1
          fi
          # Verify catch-all route exists in App.tsx
          if ! grep -q 'path="\*"' "src/App.tsx"; then
            echo "Error: Catch-all route not found in App.tsx (QA spec WI-008)"
            exit 1
          fi
          echo "‚úÖ QA DE-007: 404 handling implemented"
          echo "‚úÖ QA WI-008: NotFound component exists"
          echo "‚úÖ QA WI-008: NotFound component integrated in routing"
          echo "‚úÖ QA WI-008: Catch-all route configured"
          
      - name: Setup Pages
        uses: actions/configure-pages@v4
        
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
  
  smoke-test:
    name: Post-Deployment Smoke Tests
    runs-on: ubuntu-latest
    needs: deploy
    
    steps:
      - name: Wait for deployment propagation
        run: sleep 30
        
      - name: Test Homepage (/)
        run: |
          echo "üî• Testing homepage..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lovable-ldcs.github.io/Course-creator/)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Homepage returns 200 OK"
          else
            echo "‚ùå Homepage returned $RESPONSE (expected 200)"
            echo "‚ö†Ô∏è  This indicates deployment failed or GitHub Pages is misconfigured"
            exit 1
          fi
          
      - name: Test Engine1 Route (/engine1)
        run: |
          echo "üî• Testing /engine1 route..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lovable-ldcs.github.io/Course-creator/engine1)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ /engine1 returns 200 OK"
          else
            echo "‚ùå /engine1 returned $RESPONSE (expected 200)"
            echo "‚ö†Ô∏è  Base path configuration may be incorrect"
            exit 1
          fi
          
      - name: Test Engine2 Route (/engine2)
        run: |
          echo "üî• Testing /engine2 route..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lovable-ldcs.github.io/Course-creator/engine2)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ /engine2 returns 200 OK"
          else
            echo "‚ùå /engine2 returned $RESPONSE (expected 200)"
            exit 1
          fi
          
      - name: Test System Health Route (/system-health)
        run: |
          echo "üî• Testing /system-health route..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lovable-ldcs.github.io/Course-creator/system-health)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ /system-health returns 200 OK"
          else
            echo "‚ùå /system-health returned $RESPONSE (expected 200)"
            exit 1
          fi
      
      - name: Test 404 Handling (invalid route)
        run: |
          echo "üî• Testing 404 handling..."
          RESPONSE=$(curl -s -o /dev/null -w "%{http_code}" https://lovable-ldcs.github.io/Course-creator/nonexistent-route)
          
          # For SPA with client-side routing, this should return 200
          # (GitHub Pages serves index.html, React Router handles 404)
          if [ "$RESPONSE" = "200" ]; then
            echo "‚úÖ Invalid route returns 200 (SPA handles 404 client-side)"
          elif [ "$RESPONSE" = "404" ]; then
            echo "‚ö†Ô∏è  Invalid route returned 404"
            echo "This might indicate GitHub Pages 404, not the app's NotFound component"
            echo "Checking if it's GitHub's 404 page..."
            
            BODY=$(curl -s https://lovable-ldcs.github.io/Course-creator/nonexistent-route)
            if echo "$BODY" | grep -q "File not found"; then
              echo "‚ùå Received GitHub Pages 404 page instead of app NotFound component"
              echo "This indicates the deployment or routing is broken"
              exit 1
            else
              echo "‚úÖ Appears to be custom 404 handling"
            fi
          else
            echo "‚ùå Unexpected response: $RESPONSE"
            exit 1
          fi
          
      - name: Verify no GitHub 404 on main routes
        run: |
          echo "üî• Verifying routes don't return GitHub 404 page..."
          
          # Check homepage doesn't contain GitHub's 404 text
          BODY=$(curl -s https://lovable-ldcs.github.io/Course-creator/)
          if echo "$BODY" | grep -q "File not found"; then
            echo "‚ùå CRITICAL: Homepage is showing GitHub's 404 page!"
            echo "Deployment has FAILED. Common causes:"
            echo "  - GitHub Pages not enabled in repository settings"
            echo "  - Source not set to 'GitHub Actions' in Pages settings"
            echo "  - Deployment workflow didn't complete successfully"
            echo ""
            echo "Body preview:"
            echo "$BODY" | head -20
            exit 1
          else
            echo "‚úÖ Homepage is not showing GitHub 404 page"
          fi
          
      - name: Deployment Smoke Test Summary
        run: |
          echo ""
          echo "========================================="
          echo "‚úÖ ALL DEPLOYMENT SMOKE TESTS PASSED"
          echo "========================================="
          echo ""
          echo "The following routes are accessible:"
          echo "  ‚úÖ / (Homepage)"
          echo "  ‚úÖ /engine1"
          echo "  ‚úÖ /engine2"
          echo "  ‚úÖ /system-health"
          echo "  ‚úÖ 404 handling works"
          echo ""
          echo "Deployment is healthy!"
          echo ""
